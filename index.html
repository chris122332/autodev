<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoDev - Dashboard</title> <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght[email protected]&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght[email protected];700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
</head>
<body class="dark-mode">

    <header>
        <span id="logo">AutoDev</span>
        <div id="user-info" style="display: none;">
            <span id="username-display"></span>
            <button onclick="logout()">Sair</button>
        </div>
        <button id="theme-toggle" onclick="toggleTheme()"></button>
    </header>

    <main>
        <div id="notification-container"></div>
        
        <div id="overlay-loading" class="hidden">
            <div id="loading-box">
                <h2>Processando...</h2>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-bar-fill" style="width: 0%;"></div>
                </div>
                <p id="status-text" class="status-text">Iniciando a opera√ß√£o...</p>
                <div id="spinner" class="loading">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
            </div>
        </div>

        <section id="login-section" class="card">
            <h2>Login de Acesso</h2>
            <form id="login-form">
                <input type="text" id="login-username" placeholder="Usu√°rio" required>
                <input type="password" id="login-password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
            <button onclick="showRegister()">N√£o tem conta? Registre-se</button>
        </section>

        <section id="register-section" class="card hidden">
            <h2>Registro de Usu√°rio</h2>
            <form id="register-form">
                <input type="text" id="register-username" placeholder="Novo Usu√°rio" required>
                <input type="password" id="register-password" placeholder="Nova Senha" required>
                <button type="submit">Registrar</button>
            </form>
            <button onclick="showLogin()">J√° tem conta? Fa√ßa Login</button>
        </section>

        <section id="dashboard-section" class="hidden">
            
            <div id="project-management">
                <div class="card">
                    <h2>Gerador de Projeto (Chat)</h2>
                    <div id="chat-container">
                        <div id="chat-messages">
                            <div class="message bot">
                                <span class="avatar">ü§ñ</span>
                                <div class="message-content">Ol√°! Eu sou o AutoDev. Diga-me qual projeto front-end voc√™ gostaria de criar (ex: "Um site de blog responsivo com tema dark").</div>
                            </div>
                        </div>
                        <div id="chat-input-area">
                            <input type="text" id="chat-input" placeholder="Descreva seu projeto..." disabled>
                            <button id="chat-send-btn" onclick="handleChatSubmit()" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card project-list-card">
                    <h2>Meus Projetos</h2>
                    <ul id="project-list">
                        </ul>
                </div>
            </div>
            
            <div id="editor-management" class="hidden">
                <h2 id="editor-title">Editor de C√≥digo: Novo Projeto</h2>
                
                <div class="tab-buttons">
                    <button id="tab-html" class="active-tab" onclick="changeEditorTab('html')">index.html</button>
                    <button id="tab-css" onclick="changeEditorTab('css')">style.css</button>
                    <button id="tab-js" onclick="changeEditorTab('js')">script.js</button>
                </div>
                
                <div id="editor-container">
                    <div id="editor-html" class="code-editor"></div>
                    <div id="editor-css" class="code-editor hidden"></div>
                    <div id="editor-js" class="code-editor hidden"></div>
                </div>
                
                <div class="editor-actions">
                    <button onclick="saveProject()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button onclick="downloadProject()">
                        <i class="fas fa-download"></i> Baixar Projeto
                    </button>
                    <button onclick="deleteProject()">
                        <i class="fas fa-trash"></i> Excluir Projeto
                    </button>
                    <button onclick="viewProjectList()" class="secondary-btn">
                        <i class="fas fa-list"></i> Voltar para Projetos
                    </button>
                </div>
            </div>

        </section>
    </main>

    <script>
        // Vari√°veis globais para os editores
        let htmlEditor, cssEditor, jsEditor;
        let activeProject = null; // Projeto sendo editado
        
        // --- Fun√ß√µes de Notifica√ß√£o ---
        function showNotification(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type} fade-in`;
            notification.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(notification);
            
            // For√ßa o reflow para garantir a anima√ß√£o fade-in
            void notification.offsetWidth; 
            
            // Remove a notifica√ß√£o ap√≥s 'duration'
            setTimeout(() => {
                notification.classList.remove('fade-in');
                notification.classList.add('fade-out');
                // Remove o elemento ap√≥s a anima√ß√£o fade-out
                notification.addEventListener('transitionend', () => notification.remove());
            }, duration);
        }
        
        // --- Fun√ß√µes de Loading/Overlay ---
        function showLoading(message, progress = 0) {
            document.getElementById('overlay-loading').classList.remove('hidden');
            document.getElementById('status-text').textContent = message;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function updateLoading(message, progress) {
            document.getElementById('status-text').textContent = message;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function hideLoading() {
            document.getElementById('overlay-loading').classList.add('hidden');
        }

        // --- Fun√ß√µes de Login/Registro ---

        // Fun√ß√£o para mostrar a se√ß√£o de login
        function showLogin() {
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
        }
        
        // Fun√ß√£o para mostrar a se√ß√£o de registro
        function showRegister() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.remove('hidden');
        }

        // Fun√ß√£o para salvar o token e atualizar a UI
        function setLoggedIn(token, username) {
            localStorage.setItem('authToken', token);
            localStorage.setItem('username', username);
            document.getElementById('username-display').textContent = username;
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            showNotification(`Bem-vindo, ${username}!`, 'success');
            fetchProjects(); // Carrega a lista de projetos ap√≥s o login
        }
        
        // Fun√ß√£o para sair e limpar o estado
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            activeProject = null;
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('editor-management').classList.add('hidden');
            showLogin();
            showNotification('Voc√™ saiu da sua conta.', 'info');
        }

        // Fun√ß√£o para checar o estado de login ao carregar
        async function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');

            if (token && username) {
                try {
                    // Tenta validar o token no backend (pode ser uma rota /api/validate-token)
                    const response = await fetch('/api/validate-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        setLoggedIn(token, username); // Se o token for v√°lido, mant√©m o login
                    } else {
                        // Token inv√°lido/expirado
                        logout();
                    }

                } catch (error) {
                    console.error('Erro na valida√ß√£o de token:', error);
                    logout(); // Em caso de erro de rede, assume que n√£o est√° logado
                }
            } else {
                showLogin();
            }
        }

        // Event listener para o formul√°rio de login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            showLoading('Autenticando...');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado mesmo em caso de erro da resposta
                hideLoading();

                const data = await response.json();

                if (response.ok) {
                    setLoggedIn(data.token, username);
                } else {
                    showNotification(data.error || 'Credenciais inv√°lidas.', 'error');
                }
            } catch (error) {
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado em caso de erro de rede
                hideLoading();
                showNotification('Erro de rede ao tentar fazer login.', 'error');
                console.error('Erro de login:', error);
            }
        });

        // Event listener para o formul√°rio de registro
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            
            showLoading('Registrando...');

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado mesmo em caso de erro da resposta
                hideLoading();

                const data = await response.json();

                if (response.ok) {
                    showNotification('Usu√°rio registrado com sucesso! Fa√ßa login.', 'success');
                    document.getElementById('login-username').value = username;
                    document.getElementById('login-password').value = password;
                    showLogin(); // Volta para a tela de login
                } else {
                    showNotification(data.error || 'Erro ao registrar. Tente outro nome de usu√°rio.', 'error');
                }
            } catch (error) {
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado em caso de erro de rede
                hideLoading();
                showNotification('Erro de rede ao tentar registrar.', 'error');
                console.error('Erro de registro:', error);
            }
        });

        // --- Fun√ß√µes do Chat ---

        // Converte Markdown para HTML para exibir no chat
        const converter = new showdown.Converter();
        
        function appendMessage(sender, message, isError = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarSpan = document.createElement('span');
            avatarSpan.className = 'avatar';
            avatarSpan.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isError) {
                // Mensagens de erro s√£o apresentadas como texto puro (ou em negrito)
                contentDiv.innerHTML = message;
            } else {
                // Mensagens normais s√£o convertidas de Markdown
                contentDiv.innerHTML = converter.makeHtml(message);
            }

            messageDiv.appendChild(avatarSpan);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Auto-scroll para a √∫ltima mensagem
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Adiciona um placeholder de "Bot digitando..."
        function addBotTyping() {
            const chatMessages = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing';
            typingDiv.id = 'bot-typing';
            typingDiv.innerHTML = '<span class="avatar">ü§ñ</span><div class="message-content loading"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove o placeholder de "Bot digitando..."
        function removeBotTyping() {
            const typingDiv = document.getElementById('bot-typing');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // Envio de mensagem (chat)
        async function handleChatSubmit() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;
            
            // 1. Desabilita o input e bot√£o
            input.disabled = true;
            document.getElementById('chat-send-btn').disabled = true;
            
            // 2. Adiciona a mensagem do usu√°rio
            appendMessage('user', message);
            input.value = '';

            // 3. Adiciona o indicador de 'digitando' do bot
            addBotTyping();

            try {
                // Token de autentica√ß√£o
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Usu√°rio n√£o autenticado.');
                }
                
                // 4. Envia para o backend
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ prompt: message })
                });

                const data = await response.json();
                
                // 5. Remove o indicador de 'digitando'
                removeBotTyping();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erro desconhecido na comunica√ß√£o com a IA.');
                }

                // 6. Adiciona a resposta da IA
                appendMessage('bot', data.response);
                
                // Se a resposta incluir um projeto (indicado por uma flag ou estrutura), 
                // voc√™ precisar√° de uma l√≥gica para processar/salvar o projeto gerado aqui.
                // Por enquanto, assumimos que o chat √© apenas para conversa√ß√£o.
                

            } catch (error) {
                console.error('Erro no chat:', error);
                removeBotTyping();
                appendMessage('bot', `**Erro:** N√£o consegui me comunicar com o servidor/IA. Por favor, tente novamente mais tarde. (${error.message})`, true);
            } finally {
                // 7. Restaura o input
                input.disabled = false;
                document.getElementById('chat-send-btn').disabled = false;
                input.focus(); // Foca no input para facilitar a pr√≥xima mensagem
            }
        }

        // --- Fun√ß√µes de Projeto e Editor (Stub/Placeholder) ---
        
        // Fun√ß√£o que ser√° chamada ap√≥s o login para buscar a lista de projetos
        async function fetchProjects() {
            // (L√≥gica de busca de projetos no backend - n√£o implementada neste snippet)
            // Apenas restaura o estado do chat/input/bot√£o
            document.getElementById('chat-input').disabled = false;
            document.getElementById('chat-send-btn').disabled = false;
            
            // Exemplo de placeholder na lista de projetos
            const projectList = document.getElementById('project-list');
            projectList.innerHTML = '<li>Nenhum projeto salvo. Use o chat para gerar um!</li>';
            
            // Inicializa os editores na primeira vez
            if (typeof monaco === 'undefined' || !htmlEditor) {
                initMonaco();
            }
        }

        // Fun√ß√£o para abrir um projeto no editor
        function openProject(projectId, projectName, htmlCode, cssCode, jsCode) {
            // ... (L√≥gica de abertura de projeto no editor)
            // Oculta a lista e mostra o editor
            document.getElementById('project-management').classList.add('hidden');
            document.getElementById('editor-management').classList.remove('hidden');
            
            activeProject = { id: projectId, name: projectName };
            document.getElementById('editor-title').textContent = `Editor de C√≥digo: ${projectName}`;
            
            htmlEditor.setValue(htmlCode || '');
            cssEditor.setValue(cssCode || '/* Conte√∫do CSS aqui */');
            jsEditor.setValue(jsCode || '// Conte√∫do JavaScript aqui');
            
            changeEditorTab('html'); // Volta para a aba HTML
        }

        // Fun√ß√£o para salvar o projeto
        async function saveProject() {
            if (!activeProject) {
                showNotification('Nenhum projeto ativo para salvar.', 'error');
                return;
            }
            
            // ... (L√≥gica de coleta de c√≥digo e chamada de API /api/save-project)
            showLoading('Salvando Projeto...', 50);
            
            try {
                // Simula√ß√£o de delay de salvamento
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado no sucesso
                hideLoading(); 
                showNotification(`Projeto "${activeProject.name}" salvo com sucesso!`, 'success');

            } catch(error) {
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado no erro
                hideLoading(); 
                showNotification('Erro ao tentar salvar o projeto.', 'error');
                console.error('Erro de salvamento:', error);
            }
        }

        // Fun√ß√£o para voltar para a lista de projetos
        function viewProjectList() {
             document.getElementById('editor-management').classList.add('hidden');
             document.getElementById('project-management').classList.remove('hidden');
             activeProject = null;
             fetchProjects(); // Recarrega a lista
        }

        // Fun√ß√£o para alternar as abas do editor
        function changeEditorTab(type) {
            const tabs = ['html', 'css', 'js'];
            
            tabs.forEach(tab => {
                document.getElementById(`editor-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('active-tab');
            });
            
            document.getElementById(`editor-${type}`).classList.remove('hidden');
            document.getElementById(`tab-${type}`).classList.add('active-tab');
            
            // Garante que o editor ativo seja reajustado (√∫til se o container for redimensionado)
            if (type === 'html' && htmlEditor) htmlEditor.layout();
            if (type === 'css' && cssEditor) cssEditor.layout();
            if (type === 'js' && jsEditor) jsEditor.layout();
        }

        // Fun√ß√£o de inicializa√ß√£o do Monaco Editor
        function initMonaco() {
            // Configura√ß√£o do Monaco Loader
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.48.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                
                const editorOptions = {
                    theme: 'vs-dark',
                    minimap: { enabled: false },
                    fontSize: 14,
                    automaticLayout: true, // Importante para redimensionamento
                    scrollBeyondLastLine: false,
                    readOnly: false
                };

                htmlEditor = monaco.editor.create(document.getElementById('editor-html'), {
                    value: '',
                    language: 'html',
                    ...editorOptions
                });

                cssEditor = monaco.editor.create(document.getElementById('editor-css'), {
                    value: '/* Conte√∫do CSS aqui */',
                    language: 'css',
                    ...editorOptions
                });

                jsEditor = monaco.editor.create(document.getElementById('editor-js'), {
                    value: '// Conte√∫do JavaScript aqui',
                    language: 'javascript',
                    ...editorOptions
                });

            });
        }
        
        // Fun√ß√£o de Download (Stub)
        async function downloadProject() {
            if (!activeProject) {
                showNotification('Nenhum projeto ativo para download.', 'error');
                return;
            }
            
            showLoading('Preparando Download...', 50);
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/download/${activeProject.id}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado no sucesso
                hideLoading(); 

                if (response.ok) {
                    showNotification(`Download do projeto "${activeProject.name}" iniciado.`, 'info');
                    // O navegador lida com o download gra√ßas ao res.download do backend
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.setAttribute('download', `${activeProject.name}.zip`);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    const errorText = await response.text();
                    showNotification(`Erro no download: ${errorText.substring(0, 50)}...`, 'error');
                }

            } catch(error) {
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado no erro
                hideLoading();
                showNotification('Erro de rede ao tentar baixar o projeto.', 'error');
                console.error('Erro de download:', error);
            }
        }
        
        // Fun√ß√£o de Exclus√£o (Stub)
        async function deleteProject() {
            if (!activeProject || !confirm(`Tem certeza que deseja EXCLUIR o projeto "${activeProject.name}"?`)) {
                return;
            }
            
            showLoading('Excluindo Projeto...', 50);

            try {
                // ... (L√≥gica de chamada de API /api/delete-project)
                
                // Simula√ß√£o de delay de exclus√£o
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado no sucesso
                hideLoading(); 
                
                showNotification(`Projeto "${activeProject.name}" exclu√≠do com sucesso!`, 'success');
                viewProjectList(); // Volta para a lista
                
            } catch(error) {
                // AQUI: CORRE√á√ÉO: Garante que hideLoading seja chamado no erro
                hideLoading();
                showNotification('Erro ao tentar excluir o projeto.', 'error');
                console.error('Erro de exclus√£o:', error);
            }
        }

        // --- Configura√ß√µes/Utilit√°rios ---

        // Fun√ß√£o para alternar o tema Dark/Light
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            const toggleButton = document.getElementById('theme-toggle');
            
            if (isLight) {
                localStorage.setItem('theme', 'light');
                toggleButton.textContent = 'üåô Escuro';
                // Atualiza o tema do Monaco
                if (htmlEditor) {
                    monaco.editor.setTheme('vs');
                }
            } else {
                localStorage.setItem('theme', 'dark');
                toggleButton.textContent = '‚òÄÔ∏è Claro';
                // Atualiza o tema do Monaco
                if (htmlEditor) {
                    monaco.editor.setTheme('vs-dark');
                }
            }
        }

        // --- Inicializa√ß√£o ---
        
        // Verifica o tema salvo no localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            document.getElementById('theme-toggle').textContent = 'üåô Escuro';
        } else {
             document.body.classList.remove('light-mode');
             document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è Claro';
        }

        // Tenta fazer login autom√°tico ao carregar
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

    </script>

</body>
</html>
